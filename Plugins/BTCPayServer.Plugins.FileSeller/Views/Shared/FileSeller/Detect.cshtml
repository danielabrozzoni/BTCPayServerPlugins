@using BTCPayServer.Abstractions.Extensions
@using BTCPayServer.Plugins.FileSeller
@{
    FileSellerService.UrlToUse = Context.Request.GetAbsoluteRootUri();
}

<script>
function showDownloadLinks(receiptData) {
    if (!receiptData || !receiptData["Downloadable Content"]) {
        console.log("No downloadable content found in receipt data.");
        return;
    }
    console.log("Rendering downloadable content...");

    const container = document.createElement("div");
    container.style.marginTop = "20px";

    const title = document.createElement("h2");
    title.innerText = "Your Downloads:";
    container.appendChild(title);

    const list = document.createElement("ul");

    for (const [fileName, link] of Object.entries(receiptData["Downloadable Content"])) {
        const item = document.createElement("li");
        const a = document.createElement("a");
        a.href = link;
        a.className = "btn btn-primary m-1";
        a.innerText = `Download ${fileName}`;
        a.download = fileName;
        a.target = "_blank";
        item.appendChild(a);
        list.appendChild(item);
    }

    container.appendChild(list);

    const checkoutContainer = document.querySelector(".checkout-container") || document.body;
    checkoutContainer.appendChild(container);
}

document.addEventListener('DOMContentLoaded', function() {
    console.log("‚úÖ Detect.cshtml script loaded.");

    let downloadLinksShown = false;

    function tryShowDownloadsFromMetadata(metadata) {
        if (metadata && metadata.receiptData) {
            showDownloadLinks(metadata.receiptData);
            downloadLinksShown = true;
        } else {
            console.log("No receipt data available in metadata yet.");
        }
    }

    // Listen for invoice paid event (older style)
    document.addEventListener('btcpay-invoice-paid', function(e) {
        console.log("üì© Event 'btcpay-invoice-paid' fired:", e.detail);
        if (e.detail?.invoiceMetadata) {
            tryShowDownloadsFromMetadata(e.detail.invoiceMetadata);
        }
    });

    // Listen for payment event (newer BTCPay versions)
    document.addEventListener('btcpay-payment', function(e) {
        console.log("üì© Event 'btcpay-payment' fired:", e.detail);
        if (e.detail?.invoiceMetadata) {
            tryShowDownloadsFromMetadata(e.detail.invoiceMetadata);
        }
    });

    // After a short timeout, if no event received, fallback to window.invoiceData
    setTimeout(function() {
        if (!downloadLinksShown) {
            console.log("‚ö° No payment events received yet, trying fallback method...");
            if (window.invoiceData?.metadata) {
                tryShowDownloadsFromMetadata(window.invoiceData.metadata);
            } else {
                console.warn("‚ö†Ô∏è Fallback: No window.invoiceData.metadata available.");
            }
        }
    }, 2000); // Wait 2 seconds after DOMContentLoaded
});
</script>
